<!DOCTYPE html>
<html>
<head>
    <title>나만의 지능형 Chess AI</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .dashboard { display: flex; gap: 40px; background: #2c3e50; color: white; padding: 15px 50px; border-radius: 12px; margin-bottom: 20px; }
        .stat-val { font-size: 1.8em; font-weight: bold; color: #2ecc71; text-align: center; }
        .container { display: flex; gap: 20px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #myBoard { width: 450px; }
        .history-box { width: 250px; height: 450px; border: 1px solid #ddd; background: #fafafa; border-radius: 8px; overflow-y: auto; padding: 15px; font-family: monospace; }
        .controls { margin-top: 20px; display: flex; gap: 10px; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-reset { background: #e74c3c; } /* 초기화: 빨간색 */
        .btn-save { background: #27ae60; }  /* 저장: 초록색 */
    </style>
</head>
<body>
    <div class="dashboard">
        <div><div>총 학습 판수</div><div id="gameCount" class="stat-val">0</div></div>
        <div><div>지능 점수</div><div id="brainSize" class="stat-val">0</div></div>
    </div>

    <div class="container">
        <div id="myBoard"></div>
        <div id="moveList" class="history-box"></div>
    </div>

    <div class="controls">
        <button class="btn-reset" onclick="location.reload()">현재 게임 초기화</button>
        <button class="btn-save" onclick="manualSave()">학습 데이터 수동 저장</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script>
        var board = null, game = new Chess();

        function manualSave() {
            fetch('/save').then(res => { if(res.ok) alert("학습 데이터가 json 파일로 저장되었습니다."); });
        }

        function updateUI() {
            let history = game.history();
            let html = history.map((m, i) => (i%2==0 ? (Math.floor(i/2)+1)+'. ' : '') + m).join(' ');
            $('#moveList').text(html);
        }

        function onDrop (source, target) {
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            updateUI();
            
            if (game.game_over()) { finalizeGame(); return; }

            fetch('/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fen: game.fen() })
            })
            .then(res => res.json())
            .then(data => {
                if (data.move) {
                    game.move(data.move, { sloppy: true });
                    board.position(game.fen());
                    updateUI();
                    $('#gameCount').text(data.game_count);
                    $('#brainSize').text(data.brain_size);
                    if (game.game_over()) finalizeGame();
                }
            });
        }

        function finalizeGame() {
            let winner = game.in_checkmate() ? (game.turn() === 'w' ? "Black" : "White") : "Draw";
            fetch('/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fen: game.fen(), result: winner })
            }).then(() => {
                alert("게임 종료: " + winner + " 승리! 다음 판을 시작합니다.");
                location.reload();
            });
        }

        board = ChessBoard('myBoard', { draggable: true, position: 'start', onDrop: onDrop, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
    </script>
</body>
</html>